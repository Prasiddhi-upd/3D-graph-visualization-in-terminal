<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Graph Test</title>
  <style>
    body {
      margin: 0;
      overflow: hidden; /* Prevent scrollbars on body */
    }
    #graph-container {
      width: 100vw;  /* Use full viewport width */
      height: 100vh; /* Use full viewport height */
    }
  </style>
  <script src="https://unpkg.com/3d-force-graph"></script>
  <script type="module">
    // Initialize the WASM module and the DotParser
    import init, { DotParser } from './pkg/dot_parser_wasm.js';

    // Function to initialize the WASM module
    async function initWASM() {
      await init();  // Initializes the WASM module
      console.log("WASM module initialized");
    }

    // Function to fetch and parse the DOT file
    async function fetchDotData() {
      try {
        // Fetch the DOT file (example.dot)
        const response = await fetch('example.dot');
        const dotText = await response.text();
        
        // Parse the DOT file using the WASM parser
        const dotParser = new DotParser();
        const parsedData = await dotParser.parse(dotText);  // Ensure you await the parse function
        
        console.log("Raw parsed data:", parsedData); // Debug the format
        processGraphData(parsedData);
      } catch (err) {
        console.error("Failed to fetch or parse DOT file:", err);
      }
    }

    // Function to process the parsed DOT data and create a 3D graph
    function processGraphData(parsedData) {
  try {
    const graphData = { nodes: [], links: [] };
    const graphObject = typeof parsedData === 'string' ? JSON.parse(parsedData) : parsedData;

    // Check for either "edges" or "links"
    const links = graphObject.edges || graphObject.links;
    if (!graphObject.nodes || !links) {
      throw new Error("Parsed data is missing 'nodes' or 'edges/links'");
    }

    // Process nodes
    graphObject.nodes.forEach(node => {
      graphData.nodes.push({ 
        id: node.id, 
        name: node.label || node.id
      });
    });

    // Process edges (renamed to links)
    links.forEach(edge => {
      graphData.links.push({ 
        source: edge.source, 
        target: edge.target,
        label: edge.label || ""
      });
    });

    // Render the graph (with all nodes same color and links as thin lines)
    const Graph = ForceGraph3D()(document.getElementById('graph-container'))
      .graphData(graphData)
      .nodeLabel('name')
      .nodeAutoColorBy('id')  // You can keep this to automatically color nodes based on their ID or remove it for uniform color
      .nodeColor('#3498db')   // Set all nodes to a fixed color (e.g., blue)
      .linkWidth(1)           // Make links thinner
      .linkOpacity(0.6)       // Set link opacity to make them less prominent
      .linkColor('#BDC3C7');  // Optional: Set a specific color for links (e.g., light gray)

    Graph.cameraPosition({ x: 0, y: 0, z: 3000 }, true);
  } catch (err) {
    console.error("Failed to process graph data:", err);
  }
}


    // Initialize WASM and fetch the DOT data after WASM is initialized
    initWASM().then(() => {
      fetchDotData();  // Fetch and process the DOT data after WASM initialization
    });
  </script>
</head>
<body>
  <div id="graph-container">
    <!-- Graph will be dynamically added here -->
  </div>
</body>
</html>